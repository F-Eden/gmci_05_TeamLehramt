<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Live Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 1rem auto;
    padding: 1rem;
  }
  h1 {
    text-align: center;
  }
  .question-list {
    margin-top: 2rem;
  }
  .question-item {
    background: #f8f9fa;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .question-text {
    flex-grow: 1;
  }
  label {
    cursor: pointer;
  }
  #statusMessage {
    margin-top: 1rem;
    font-weight: bold;
  }
  #chatContainer {
    border: 1px solid #ccc;
    height: 250px;
    overflow-y: auto;
    padding: 10px;
    margin-top: 1rem;
    background: #fafafa;
  }
  #chatInput {
    width: 80%;
    padding: 0.5rem;
    font-size: 1rem;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #sendChatBtn {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    background-color: #2980b9;
    color: white;
    border: none;
    border-radius: 4px;
  }
  #sendChatBtn:hover {
    background-color: #2771a3;
  }
  .chat-message {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
  }
</style>
</head>
<body>

<h1>Live Dashboard</h1>

<div id="sessionTitle"><em>Lädt …</em></div>
<div class="question-list" id="questionList"></div>
<div id="statusMessage"></div>

<!-- Chat -->
<h2>Live Chat</h2>
<div id="chatContainer"></div>
<input type="text" id="chatInput" placeholder="Nachricht schreiben..." />
<button id="sendChatBtn">Senden</button>

<script>
  const chatContainer = document.getElementById('chatContainer');
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');

  const sessionId = new URLSearchParams(window.location.search).get('id');
  if (!sessionId) alert('Keine Session-ID angegeben!');

  // Chatnachricht hinzufügen
  function addChatMessage(text, fromModerator = false) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('chat-message');
    msgDiv.textContent = fromModerator ? `(Moderator) ${text}` : text;
    chatContainer.appendChild(msgDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // Vorhandene Chatnachrichten laden
  async function loadExistingChats() {
    const mangoQuery = {
      selector: { type: 'chat', sessionId: sessionId },
      sort: [{timestamp: 'asc'}]
    };

    const res = await fetch('http://localhost:5984/gmci/_find', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(mangoQuery)
    });
    const data = await res.json();
    data.docs.forEach(chat => addChatMessage(chat.message, chat.fromModerator));
  }

  // Chatnachricht senden (Moderator)
  async function sendChatMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return alert('Nachricht ist leer');
    const chatDoc = {
      type: 'chat',
      sessionId: sessionId,
      timestamp: new Date().toISOString(),
      fromModerator: true,
      message: msg
    };
    try {
      const res = await fetch('http://localhost:5984/gmci', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(chatDoc)
      });
      if (!res.ok) {
        alert('Fehler beim Senden');
      } else {
        chatInput.value = '';
      }
    } catch(e) {
      alert('Netzwerkfehler');
      console.error(e);
    }
  }

  sendChatBtn.addEventListener('click', sendChatMessage);
  chatInput.addEventListener('keypress', e => {
    if(e.key === 'Enter') {
      e.preventDefault();
      sendChatMessage();
    }
  });

  // Live Updates über CouchDB Changes Feed
  const source = new EventSource(`http://localhost:5984/gmci/_changes?feed=eventsource&since=now&include_docs=true`);
  source.onmessage = event => {
    const change = JSON.parse(event.data);
    const doc = change.doc;
    if (doc.type === 'chat' && doc.sessionId === sessionId) {
      addChatMessage(doc.message, !!doc.fromModerator);
    }
  };

  // Sessionanzeigen, Frage freischalten usw. bleiben unverändert
  const questionList = document.getElementById('questionList');
  const sessionTitleDiv = document.getElementById('sessionTitle');
  const statusMessage = document.getElementById('statusMessage');

  let sessionDoc = null;

  // ID aus URL auslesen
  function getSessionId() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
  }

  async function loadSession() {
    try {
      const res = await fetch(`http://localhost:5984/gmci/${encodeURIComponent(sessionId)}`);
      if (!res.ok) throw new Error(`Session ${sessionId} nicht gefunden`);
      sessionDoc = await res.json();

      sessionTitleDiv.textContent = `Session: ${sessionDoc.title}`;
      renderQuestions();
    } catch (err) {
      sessionTitleDiv.textContent = 'Fehler beim Laden der Session.';
      console.error(err);
    }
  }

  function isQuestionUnlocked(qId) {
    return Array.isArray(sessionDoc.unlockedQuestions) && sessionDoc.unlockedQuestions.includes(qId);
  }

  async function saveSessionDoc() {
    if (!sessionDoc || !sessionDoc._id) return;
    try {
      const res = await fetch(`http://localhost:5984/gmci/${encodeURIComponent(sessionDoc._id)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sessionDoc)
      });
      if (!res.ok) {
        const error = await res.json();
        statusMessage.textContent = 'Fehler beim Speichern: ' + (error.reason || res.statusText);
        return false;
      }
      const data = await res.json();
      sessionDoc._rev = data.rev;
      statusMessage.textContent = 'Speicherung erfolgreich ✔';
      setTimeout(() => statusMessage.textContent = '', 3000);
      return true;
    } catch (e) {
      statusMessage.textContent = 'Netzwerkfehler beim Speichern';
      console.error(e);
      return false;
    }
  }

  function renderQuestions() {
    questionList.innerHTML = '';

    if (!Array.isArray(sessionDoc.questions) || sessionDoc.questions.length === 0) {
      questionList.textContent = 'Keine Fragen vorhanden.';
      return;
    }

    sessionDoc.questions.forEach(question => {
      const div = document.createElement('div');
      div.classList.add('question-item');

      const label = document.createElement('label');
      label.classList.add('question-text');
      label.textContent = question.text;

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = isQuestionUnlocked(question.id);
      checkbox.title = 'Frage freischalten/sperren';

      checkbox.addEventListener('change', async () => {
        statusMessage.textContent = 'Speichere Änderung...';
        if (!Array.isArray(sessionDoc.unlockedQuestions)) {
          sessionDoc.unlockedQuestions = [];
        }
        if (checkbox.checked) {
          if (!sessionDoc.unlockedQuestions.includes(question.id)) {
            sessionDoc.unlockedQuestions.push(question.id);
          }
        } else {
          sessionDoc.unlockedQuestions = sessionDoc.unlockedQuestions.filter(id => id !== question.id);
        }
        const success = await saveSessionDoc();
        if (!success) {
          checkbox.checked = !checkbox.checked;
        }
      });

      div.appendChild(label);
      div.appendChild(checkbox);
      questionList.appendChild(div);
    });
  }

  window.onload = () => {
    loadExistingChats();
    loadSession();
  };
</script>

</body>
</html>