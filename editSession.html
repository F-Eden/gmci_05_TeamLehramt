<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Session bearbeiten</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }
    nav {
      width: 150px;
      background-color: #2c3e50;
      border-right: 1px solid #34495e;
      padding: 1rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    nav a {
      display: block;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    nav a:hover {
      background-color: #34495e;
    }
    nav a.active {
      background-color: #f1c40f;
      font-weight: bold;
      color: black;
    }
    main {
      flex-grow: 1;
      padding: 1.5rem;
      box-sizing: border-box;
      background-color: #fff;
      overflow-y: auto;
    }
    h1 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      margin-top: 1rem;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      background-color: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2471a3;
    }
    .questions-container {
      margin-top: 1rem;
    }
    .question-item {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 1rem;
      background: #f9f9f9;
      position: relative;
    }
    .question-item label {
      font-weight: normal;
    }
    .question-remove {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #e74c3c;
      color: white;
      border: none;
      font-weight: bold;
      border-radius: 3px;
      cursor: pointer;
      padding: 0 7px;
      font-size: 1rem;
      line-height: 1;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Startseite</a>
    <a href="newSession.html">Sessions</a>
    <a href="auswertung.html">Auswertung</a>
    <a href="profil.html">Profil</a>
  </nav>

  <main>
    <h1>Session bearbeiten</h1>

    <form id="editSessionForm">
      <label for="sessionTitle">Titel der Session:</label>
      <input type="text" id="sessionTitle" name="sessionTitle" disabled />

      <label>Fragen zur Session</label>
      <div id="questionsContainer" class="questions-container">
        <!-- Fragen geladen und bearbeitbar hier -->
      </div>

      <button type="button" id="addQuestionBtn">Frage hinzufügen</button>
      <button type="button" id="saveSessionBtn">Speichern</button>
    </form>

    <div id="qrCodeContainer" style="margin-top: 1rem;"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    const questionsContainer = document.getElementById('questionsContainer');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const saveSessionBtn = document.getElementById('saveSessionBtn');
    const qrCodeContainer = document.getElementById('qrCodeContainer');
    const titleInput = document.getElementById('sessionTitle');

    // ID aus URL auslesen
    function getSessionIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // Fragelement erzeugen (wie im newSession, hier mit vorherigen Werten)
    function createQuestionElement(q = null) {
      const qId = q?.id || ('q' + Date.now());
      const text = q?.text || '';
      const type = q?.type || '';

      const questionDiv = document.createElement('div');
      questionDiv.classList.add('question-item');
      questionDiv.setAttribute('data-qid', qId);

      questionDiv.innerHTML = `
        <button type="button" class="question-remove" title="Frage entfernen">&times;</button>
        <label for="${qId}_text">Frage:</label>
        <input type="text" id="${qId}_text" name="${qId}_text" value="${text}" required />
        
        <label for="${qId}_type">Bewertungsart:</label>
        <select id="${qId}_type" name="${qId}_type" required>
          <option value="" disabled ${type === '' ? 'selected' : ''}>Bewertungsart wählen</option>
          <option value="stars" ${type === 'stars' ? 'selected' : ''}>Sternebewertung</option>
          <option value="emoji" ${type === 'emoji' ? 'selected' : ''}>Emojis</option>
          <option value="text" ${type === 'text' ? 'selected' : ''}>Freitext</option>
        </select>
      `;

      questionDiv.querySelector('.question-remove').addEventListener('click', () => {
        questionsContainer.removeChild(questionDiv);
      });

      return questionDiv;
    }

    // Session Daten laden
    async function loadSession() {
      const id = getSessionIdFromUrl();
      if (!id) {
        alert('Keine Session-ID angegeben.');
        return;
      }

      const url = `http://localhost:5984/gmci/${encodeURIComponent(id)}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Session nicht gefunden');
        const session = await res.json();

        titleInput.value = session.title;

        questionsContainer.innerHTML = '';
        session.questions?.forEach(q => {
          questionsContainer.appendChild(createQuestionElement(q));
        });

        // QR-Code anzeigen
        qrCodeContainer.innerHTML = '';
        const qrData = `https://deineuniseite.edu/session/${id}`;
        QRCode.toCanvas(qrCodeContainer, qrData, { width: 200 }, err => {
          if (err) console.error(err);
        });
      } catch (err) {
        alert('Fehler beim Laden der Session: ' + err.message);
      }
    }

    addQuestionBtn.addEventListener('click', () => {
      questionsContainer.appendChild(createQuestionElement());
    });

    saveSessionBtn.addEventListener('click', async () => {
      const id = getSessionIdFromUrl();
      if (!id) {
        alert('Keine Session-ID gefunden.');
        return;
      }

      // Session Titel (nicht änderbar, nur für Referenz)
      const title = titleInput.value.trim();
      if (!title) {
        alert('Session Titel ist ungültig.');
        return;
      }

      // Fragen auslesen und validieren
      const questionDivs = questionsContainer.querySelectorAll('.question-item');
      if (questionDivs.length === 0) {
        alert('Bitte füge mindestens eine Frage hinzu.');
        return;
      }

      const questions = [];
      for (const div of questionDivs) {
        const qId = div.getAttribute('data-qid');
        const textInput = div.querySelector(`input[name="${qId}_text"]`);
        const typeSelect = div.querySelector(`select[name="${qId}_type"]`);

        if (!textInput.value.trim()) {
          alert('Bitte Text für alle Fragen eingeben.');
          return;
        }
        if (!typeSelect.value) {
          alert('Bitte Bewertungsart für alle Fragen auswählen.');
          return;
        }

        questions.push({
          id: qId,
          text: textInput.value.trim(),
          type: typeSelect.value
        });
      }

      const sessionDoc = {
        _id: id,
        type: 'session',
        title: title,
        questions: questions,
        createdAt: new Date().toISOString()
      };

      // Zum Update muss _rev gesetzt werden. Erst die aktuelle Session laden.
      try {
        const docRes = await fetch(`http://localhost:5984/gmci/${encodeURIComponent(id)}`);
        if(!docRes.ok) throw new Error('Session nicht gefunden');
        const doc = await docRes.json();

        // _rev ermitteln und setzen
        sessionDoc._rev = doc._rev;

        // Update per PUT absenden
        const putRes = await fetch(`http://localhost:5984/gmci/${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(sessionDoc)
        });

        if (!putRes.ok) {
          const errorData = await putRes.json();
          alert('Fehler beim Speichern: ' + (errorData.reason || putRes.statusText));
          return;
        }

        alert('Session erfolgreich aktualisiert!');
      } catch (err) {
        alert('Fehler beim Speichern: ' + err.message);
      }
    });

    window.onload = loadSession;
  </script>
</body>
</html>