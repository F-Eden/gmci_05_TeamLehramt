<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Neue Session erstellen</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }
    nav {
      width: 150px;
      background-color: #2c3e50;
      border-right: 1px solid #34495e;
      padding: 1rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    nav a {
      display: block;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    nav a:hover {
      background-color: #34495e;
    }
    nav a.active {
      background-color: #f1c40f;
      font-weight: bold;
      color: black;
    }
    main {
      flex-grow: 1;
      padding: 1.5rem;
      box-sizing: border-box;
      background-color: #fff;
      overflow-y: auto;
    }
    h1 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      margin-top: 1rem;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      background-color: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2471a3;
    }
    .questions-container {
      margin-top: 1rem;
    }
    .question-item {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 1rem;
      background: #f9f9f9;
      position: relative;
    }
    .question-item label {
      font-weight: normal;
    }
    .question-remove {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #e74c3c;
      color: white;
      border: none;
      font-weight: bold;
      border-radius: 3px;
      cursor: pointer;
      padding: 0 7px;
      font-size: 1rem;
      line-height: 1;
    }
    #qrCodeContainer {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Startseite</a>
    <a href="sessions.html" class="active">Sessions</a>
    <a href="auswertung.html">Auswertung</a>
    <a href="profil.html">Profil</a>
  </nav>

  <main>
    <h1>Neue Session</h1>

    <form id="sessionForm">
      <label for="sessionTitle">Titel der Session:</label>
      <input type="text" id="sessionTitle" name="sessionTitle" required />

      <label>Fragen zur Session</label>
      <div id="questionsContainer" class="questions-container">
        <!-- Fragen erscheinen hier -->
      </div>

      <button type="button" id="addQuestionBtn">Frage hinzufügen</button>
      <button type="button" id="saveSessionBtn">Session speichern & QR-Code generieren</button>
    </form>

    <div id="qrCodeContainer"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    const questionsContainer = document.getElementById('questionsContainer');
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const saveSessionBtn = document.getElementById('saveSessionBtn');
    const qrCodeContainer = document.getElementById('qrCodeContainer');

    let questionCount = 0;

    // Slugify Titel → ID
    function slugify(text) {
      return text.toString().toLowerCase()
        .trim()
        .replace(/\s+/g, '-')      
        .replace(/[^\w\-]+/g, '')  
        .replace(/\-\-+/g, '-');   
    }

    function createQuestionElement(q = null) {
    const qId = q?.id || ('q' + Date.now());
    const text = q?.text || '';
    const type = q?.type || '';

    const questionDiv = document.createElement('div');
    questionDiv.classList.add('question-item');
    questionDiv.setAttribute('data-qid', qId);

    let mcOptionsHtml = '';
    if (type === 'multiple-choice') {
        const options = q?.options || [];
        mcOptionsHtml = `
        <div class="mc-options-container">
            <label>Antwortoptionen:</label>
            <ul class="mc-options-list">
            ${options.map((opt, i) => `
                <li>
                <input type="text" name="${qId}_option_${i}" value="${opt}" required />
                <button type="button" class="remove-option" title="Option entfernen">×</button>
                </li>`).join('')}
            </ul>
            <button type="button" class="add-option">Option hinzufügen</button>
        </div>
        `;
    }

    questionDiv.innerHTML = `
        <button type="button" class="question-remove" title="Frage entfernen">&times;</button>
        <label for="${qId}_text">Frage:</label>
        <input type="text" id="${qId}_text" name="${qId}_text" value="${text}" required />
        
        <label for="${qId}_type">Bewertungsart:</label>
        <select id="${qId}_type" name="${qId}_type" required>
        <option value="" disabled ${type === '' ? 'selected' : ''}>Bewertungsart wählen</option>
        <option value="stars" ${type === 'stars' ? 'selected' : ''}>Sternebewertung</option>
        <option value="emoji" ${type === 'emoji' ? 'selected' : ''}>Emojis</option>
        <option value="text" ${type === 'text' ? 'selected' : ''}>Freitext</option>
        <option value="multiple-choice" ${type === 'multiple-choice' ? 'selected' : ''}>Multiple Choice</option>
        </select>
        ${mcOptionsHtml}
    `;

    questionDiv.querySelector('.question-remove').addEventListener('click', () => {
        questionsContainer.removeChild(questionDiv);
    });

    if (type === 'multiple-choice') {
        const addOptionBtn = questionDiv.querySelector('.add-option');
        const optionsList = questionDiv.querySelector('.mc-options-list');

        addOptionBtn.addEventListener('click', () => {
        const optionCount = optionsList.children.length;
        const li = document.createElement('li');
        li.innerHTML = `
            <input type="text" name="${qId}_option_${optionCount}" value="" required />
            <button type="button" class="remove-option" title="Option entfernen">×</button>
        `;
        li.querySelector('.remove-option').addEventListener('click', () => {
            li.remove();
        });
        optionsList.appendChild(li);
        });

        questionDiv.querySelectorAll('.remove-option').forEach(btn => {
        btn.addEventListener('click', e => {
            e.target.closest('li').remove();
        });
        });
    }

    questionDiv.querySelector(`#${qId}_type`).addEventListener('change', (e) => {
        if (e.target.value === 'multiple-choice') {
        if (!questionDiv.querySelector('.mc-options-container')) {
            const mcDiv = document.createElement('div');
            mcDiv.classList.add('mc-options-container');
            mcDiv.innerHTML = `
            <label>Antwortoptionen:</label>
            <ul class="mc-options-list"></ul>
            <button type="button" class="add-option">Option hinzufügen</button>
            `;
            questionDiv.appendChild(mcDiv);

            const addOptionBtn = mcDiv.querySelector('.add-option');
            const optionsList = mcDiv.querySelector('.mc-options-list');

            addOptionBtn.addEventListener('click', () => {
            const optionCount = optionsList.children.length;
            const li = document.createElement('li');
            li.innerHTML = `
                <input type="text" name="${qId}_option_${optionCount}" value="" required />
                <button type="button" class="remove-option" title="Option entfernen">×</button>
            `;
            li.querySelector('.remove-option').addEventListener('click', () => {
                li.remove();
            });
            optionsList.appendChild(li);
            });
        }
        } else {
        const mcDiv = questionDiv.querySelector('.mc-options-container');
        if (mcDiv) mcDiv.remove();
        }
    });

    return questionDiv;
    }

    addQuestionBtn.addEventListener('click', () => {
      const newQuestion = createQuestionElement();
      questionsContainer.appendChild(newQuestion);
    });

    saveSessionBtn.addEventListener('click', async () => {
      const title = document.getElementById('sessionTitle').value.trim();
      if (!title) {
        alert('Bitte gib einen Titel für die Session ein.');
        return;
      }

      const questionDivs = questionsContainer.querySelectorAll('.question-item');
      if (questionDivs.length === 0) {
        alert('Bitte füge mindestens eine Frage hinzu.');
        return;
      }

      const questions = [];
        for (const div of questionDivs) {
        const qId = div.getAttribute('data-qid');
        const textInput = div.querySelector(`input[name="${qId}_text"]`);
        const typeSelect = div.querySelector(`select[name="${qId}_type"]`);
        
        if (!textInput.value.trim()) {
            alert('Bitte Text für alle Fragen eingeben.');
            return;
        }
        if (!typeSelect.value) {
            alert('Bitte Bewertungsart für alle Fragen auswählen.');
            return;
        }

        let options = [];
        if (typeSelect.value === 'multiple-choice') {
            options = Array.from(div.querySelectorAll('.mc-options-list input[type="text"]'))
            .map(input => input.value.trim())
            .filter(v => v.length > 0);
            if (options.length === 0) {
            alert('Bitte mindestens eine Option bei Multiple-Choice-Fragen eingeben.');
            return;
            }
        }

        questions.push({
            id: qId,
            text: textInput.value.trim(),
            type: typeSelect.value,
            ...(options.length ? {options} : {})
        });
        }

      const id = slugify(title);
      const couchUrl = `http://localhost:5984/gmci/${encodeURIComponent(id)}`;

      try {
        // Prüfen ob Session mit ID existiert
        const headResponse = await fetch(couchUrl, { method: 'HEAD' });
        if (headResponse.ok) {
          alert('Eine Session mit diesem Titel existiert bereits! Bitte wähle einen anderen Namen.');
          return;
        }
      } catch(e) {
        console.warn('Fehler beim Prüfen der Session-ID', e);
      }

      const sessionDoc = {
        _id: id,
        type: 'session',
        title: title,
        questions: questions,
        createdAt: new Date().toISOString()
      };

      try {
        const putResponse = await fetch(couchUrl, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sessionDoc)
        });

        if (putResponse.ok) {
          alert('Session erfolgreich gespeichert!');
          window.location.href = 'sessions.html';
          const qrData = `https://deineuniseite.edu/session/${id}`;
          qrCodeContainer.innerHTML = '';
          QRCode.toCanvas(qrCodeContainer, qrData, { width: 200 }, err => {
            if (err) console.error(err);
          });
          document.getElementById('sessionForm').reset();
          questionsContainer.innerHTML = '';
          questionCount = 0;
        } else {
          const errorData = await putResponse.json();
          alert('Fehler beim Speichern: ' + (errorData.reason || putResponse.statusText));
        }
      } catch (err) {
        alert('Fehler beim Verbinden mit CouchDB: ' + err.message);
      }
    });
  </script>
</body>
</html>